-- ============================================================================
-- MIGRATION 018: POA&M Vulnerability Finding Linking
-- Enables many-to-many relationship between POA&Ms and vulnerability findings
-- Supports manual linking of scan findings to POA&Ms for remediation tracking
-- ============================================================================

-- ============================================================================
-- 1. JUNCTION TABLE: POAM â†” VULNERABILITY FINDINGS
-- ============================================================================

CREATE TABLE IF NOT EXISTS poam_vulnerability_findings (
  id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  poam_id TEXT NOT NULL REFERENCES poams(id) ON DELETE CASCADE,
  finding_id TEXT NOT NULL REFERENCES vulnerability_findings(id) ON DELETE CASCADE,
  link_reason TEXT CHECK (link_reason IN ('root_cause', 'related', 'evidence', 'grouped')) DEFAULT 'related',
  notes TEXT,
  linked_by TEXT REFERENCES users(id),
  linked_at TEXT DEFAULT (datetime('now')),
  UNIQUE(poam_id, finding_id)
);

-- ============================================================================
-- 2. INDEXES FOR PERFORMANCE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_poam_vuln_poam ON poam_vulnerability_findings(poam_id);
CREATE INDEX IF NOT EXISTS idx_poam_vuln_finding ON poam_vulnerability_findings(finding_id);

-- ============================================================================
-- 3. TRACK MIGRATION
-- ============================================================================

INSERT OR IGNORE INTO schema_migrations (version, name, description)
VALUES ('migrate-018-poam-vulnerability-linking', 'poam-vulnerability-linking',
        'Many-to-many POA&M to vulnerability findings junction table');
